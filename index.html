<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶∞‡¶Æ‡¶ú‡¶æ‡¶® ‡¶á‡¶´‡¶§‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:system-ui;background:linear-gradient(#021b15,#064e3b);color:white}
header{padding:18px;text-align:center;font-size:22px;font-weight:700}
.container{max-width:1000px;margin:auto;padding:16px}
.card{background:white;color:#111;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.2);cursor:pointer}
input,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd}
button{background:#059669;color:white;border:none;font-weight:600}
.vote{display:flex;gap:8px;margin-top:10px}
.vote button{flex:1}
#map{height:340px;border-radius:14px;margin-bottom:16px}
</style>
</head>

<body>

<header>üåô ‡¶∞‡¶Æ‡¶ú‡¶æ‡¶® ‡¶á‡¶´‡¶§‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ üïå</header>

<div class="container">
<div id="map"></div>

<div class="card" style="cursor:auto">
<h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
<input id="name" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
<input id="locationText" placeholder="‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
<textarea id="iftar" placeholder="‡¶á‡¶´‡¶§‡¶æ‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡¶ø ‡¶¶‡ßá‡¶¨‡ßá"></textarea>
<button onclick="addMosque()">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
<small>‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßá ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶®</small>
</div>

<div id="list"></div>
</div>

<script>

/* FIREBASE */
const firebaseConfig={
 apiKey:"AIzaSyDYn2R6RZ4Tt2X6virO5RJ6Aqumv3sCfA0",
 authDomain:"iftar-menu.firebaseapp.com",
 projectId:"iftar-menu",
 storageBucket:"iftar-menu.firebasestorage.app",
 messagingSenderId:"885118570585",
 appId:"1:885118570585:web:4c1dce6351ed555497a148"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* MAP */
let userLat=23.8103,userLng=90.4125;
let selectedLat=null,selectedLng=null;
let focusMarker=null;

const map=L.map('map').setView([userLat,userLng],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

navigator.geolocation?.getCurrentPosition(pos=>{
 userLat=pos.coords.latitude;
 userLng=pos.coords.longitude;
 map.setView([userLat,userLng],15);
 L.marker([userLat,userLng]).addTo(map).bindPopup("üìç ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá");
});

/* MAP TAP */
let selectMarker=null;
map.on('click',e=>{
 selectedLat=e.latlng.lat;
 selectedLng=e.latlng.lng;

 if(selectMarker) map.removeLayer(selectMarker);
 selectMarker=L.marker([selectedLat,selectedLng]).addTo(map)
  .bindPopup("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá").openPopup();
});

/* ADD */
async function addMosque(){
 const name=nameEl.value.trim();
 const iftar=iftarEl.value.trim();
 const locationText=locationTextEl.value.trim();
 if(!name||!iftar) return alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®");

 await db.collection('mosques').add({
  name,iftar,locationText,
  lat:selectedLat||userLat,
  lng:selectedLng||userLng,
  yes:0,no:0,
  date:new Date().toISOString().slice(0,10)
 });

 nameEl.value="";
 iftarEl.value="";
 locationTextEl.value="";
}

/* DISTANCE */
function distance(a,b,c,d){
 const R=6371;
 const dLat=(c-a)*Math.PI/180;
 const dLng=(d-b)*Math.PI/180;
 const x=Math.sin(dLat/2)**2+
 Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
 Math.sin(dLng/2)**2;
 return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* LOAD TODAY + NEAREST FIRST */
const today=new Date().toISOString().slice(0,10);

db.collection('mosques').where('date','==',today)
.onSnapshot(snap=>{

 list.innerHTML='';
 let arr=[];

 snap.forEach(doc=>{
   const d=doc.data();
   arr.push({id:doc.id,...d});
 });

 arr.sort((a,b)=>{
   return distance(userLat,userLng,a.lat,a.lng)
        - distance(userLat,userLng,b.lat,b.lng);
 });

 arr.forEach(d=>{

   const voted=localStorage.getItem('vote_'+d.id);

   const card=document.createElement('div');
   card.className='card';
   card.innerHTML=`
   <b>${d.name}</b><br>
   üìç ${d.locationText||''}<br>
   üçΩÔ∏è ${d.iftar}

   <div class="vote">
   <button onclick="event.stopPropagation();vote('${d.id}','yes')" ${voted?'disabled':''}>‚úî (${d.yes||0})</button>
   <button onclick="event.stopPropagation();vote('${d.id}','no')" ${voted?'disabled':''}>‚úñ (${d.no||0})</button>
   </div>
   `;

   /* CLICK ‚Üí MAP PIN */
   card.onclick=()=>{
     map.setView([d.lat,d.lng],17);
     if(focusMarker) map.removeLayer(focusMarker);
     focusMarker=L.marker([d.lat,d.lng])
       .addTo(map)
       .bindPopup(`<b>${d.name}</b><br>${d.iftar}`)
       .openPopup();
     window.scrollTo({top:0,behavior:'smooth'});
   };

   list.appendChild(card);
 });

});

/* VOTE */
async function vote(id,type){
 if(localStorage.getItem('vote_'+id)) return alert("‡¶≠‡ßã‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
 const ref=db.collection('mosques').doc(id);
 await db.runTransaction(async t=>{
   const doc=await t.get(ref);
   const data=doc.data();
   if(type==='yes') t.update(ref,{yes:(data.yes||0)+1});
   else t.update(ref,{no:(data.no||0)+1});
 });
 localStorage.setItem('vote_'+id,'1');
}

/* ELEMENTS */
const nameEl=document.getElementById('name');
const iftarEl=document.getElementById('iftar');
const locationTextEl=document.getElementById('locationText');
const list=document.getElementById('list');

</script>
</body>
</html>
